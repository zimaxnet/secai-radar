name: Deploy Azure Functions

on:
  push:
    branches: [ main ]
    paths:
      - 'api/**'
      - '.github/workflows/azure-functions-deploy.yml'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'secai-radar-api'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'api'
  PYTHON_VERSION: '3.12'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure Functions Core Tools
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
          sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/dotnetdev.list'
          sudo apt-get update
          sudo apt-get install azure-functions-core-tools-4 -y

      - name: Deploy to Azure Functions
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        run: |
          func azure functionapp publish ${{ env.AZURE_FUNCTIONAPP_NAME }} --python

      - name: Azure Logout
        run: |
          az logout

      # Notify on failure with actionable details
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRun = context.payload.workflow_run || {
              html_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              conclusion: 'failure'
            };
            
            const commit = context.payload.head_commit || context.payload.commits?.[0] || {};
            const commitMessage = commit.message || 'No commit message';
            const commitAuthor = commit.author?.name || commit.author?.username || 'Unknown';
            const commitUrl = commit.url || `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${context.sha}`;
            
            // Get workflow run details
            const runDetails = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            // Get failed jobs
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            const failedSteps = failedJobs.flatMap(job => 
              job.steps?.filter(step => step.conclusion === 'failure').map(step => ({
                job: job.name,
                step: step.name,
                conclusion: step.conclusion
              })) || []
            );
            
            // Create actionable notification
            const issueBody = `## ‚ùå Workflow Failed: ${context.workflow}

### üîç Workflow Details
- **Workflow**: ${context.workflow}
- **Branch**: ${context.ref.replace('refs/heads/', '')}
- **Commit**: [${commitMessage.split('\n')[0]}](${commitUrl})
- **Author**: ${commitAuthor}
- **Run**: [View Failed Run](${workflowRun.html_url})
- **Triggered by**: ${context.eventName} (${context.actor})

### ‚ùå Failed Jobs/Steps
${failedSteps.length > 0 ? failedSteps.map(step => `- **${step.job}** ‚Üí ${step.step}`).join('\n') : '- Unable to determine failed steps'}

### üîß Next Steps
1. Review the [failed workflow run](${workflowRun.html_url}) for detailed error logs
2. Check the failed step(s) above for specific error messages
3. Fix the issue and push again

### üìã Common Issues
- **Python/dependency errors**: Check requirements.txt and Python version
- **Azure authentication**: Verify AZURE_CREDENTIALS secret
- **Function App deployment**: Check Function App name and publish settings
- **Installation errors**: Verify Azure Functions Core Tools installation

---
*This issue was automatically created by GitHub Actions to track the failed workflow run.*`;

            // Create an issue to track the failure
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `‚ùå Workflow Failed: ${context.workflow} - ${context.ref.replace('refs/heads/', '')}`,
                body: issueBody,
                labels: ['workflow-failure', 'needs-attention']
              });
              console.log('‚úÖ Created issue for failed workflow');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not create issue (may already exist or permissions issue):', error.message);
            }

