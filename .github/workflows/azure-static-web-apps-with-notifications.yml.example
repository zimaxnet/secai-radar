name: Build and Deploy SecAI Radar (SWA)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Build the web app
      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install & Build Web
        working-directory: web
        env:
          # Set API URL from secret or default Function App URL
          VITE_API_BASE: ${{ secrets.VITE_API_BASE || 'https://secai-radar-api.azurewebsites.net/api' }}
        run: |
          npm ci
          npm run build

      # Deploy Web only (API is deployed separately as Function App)
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "upload"
          app_location: "web"
          output_location: "dist"

      # Slack Notification on Failure
      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "❌ Static Web App Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*❌ Workflow Failed: Build and Deploy SecAI Radar (SWA)*\n*Branch:* ${{ github.ref_name }}\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.event.head_commit.message }}>\n*Author:* ${{ github.event.head_commit.author.name }}\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }

      # Email Notification on Failure (Alternative)
      # - name: Send Email on Failure
      #   if: failure()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: ${{ secrets.SMTP_HOST }}
      #     server_port: ${{ secrets.SMTP_PORT }}
      #     username: ${{ secrets.SMTP_USER }}
      #     password: ${{ secrets.SMTP_PASSWORD }}
      #     subject: "❌ Static Web App Deployment Failed: ${{ github.workflow }}"
      #     to: ${{ secrets.EMAIL_TO }}
      #     from: GitHub Actions
      #     body: |
      #       Workflow: ${{ github.workflow }}
      #       Branch: ${{ github.ref_name }}
      #       Commit: ${{ github.event.head_commit.message }}
      #       Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}


