# Builds containers via az acr build (runs on Azure ACR; CPU only, no GPU).
# Deploys public-api (and optionally registry-api) to Azure Container Apps.
#
# Required secrets:
#   AZURE_CREDENTIALS       - Service principal for Azure (subscription/resource group)
#   ACR_NAME                - ACR login name (e.g. secairadardevacr)
#   AZURE_STATIC_WEB_APPS_API_TOKEN
#   DATABASE_URL            - PostgreSQL connection string for public-api (for create/secret update)
#
# Optional secrets:
#   VITE_API_BASE          - Frontend API base URL (e.g. https://<public-api-fqdn>/api)
#   CONTAINER_APPS_ENV     - Container Apps environment name (default: secai-radar-dev-env)
#
name: Deploy to Staging

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  AZURE_RESOURCE_GROUP: secai-radar-rg
  AZURE_LOCATION: centralus

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: apps/public-web/package-lock.json
      
      - name: Install and build public-web
        working-directory: apps/public-web
        env:
          VITE_API_BASE: ${{ secrets.VITE_API_BASE || 'https://secai-radar-api.azurewebsites.net/api' }}
        run: |
          npm ci
          npm run build
      
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "upload"
          app_location: "apps/public-web"
          output_location: "dist"
          skip_app_build: true
      
      # Build on ACR (Azure); CPU only, no GPU. Images: python:3.11-slim.
      - name: Build and push public-api
        run: |
          az acr build --registry ${{ secrets.ACR_NAME }} --image secai-radar-public-api:latest apps/public-api
      - name: Build and push registry-api
        run: |
          az acr build --registry ${{ secrets.ACR_NAME }} --image secai-radar-registry-api:latest apps/registry-api
      
      # Deploy public-api to Azure Container Apps (create on first run, update image on later runs)
      - name: Deploy public-api to Container Apps
        env:
          ACR_NAME: ${{ secrets.ACR_NAME }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CONTAINER_APPS_ENV: ${{ vars.CONTAINER_APPS_ENV }}
        run: |
          set -e
          APP_NAME="secai-radar-public-api"
          IMAGE="${ACR_NAME}.azurecr.io/secai-radar-public-api:latest"
          ENV_NAME="${CONTAINER_APPS_ENV:-secai-radar-dev-env}"

          if az containerapp show --name "$APP_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --output none 2>/dev/null; then
            echo "Updating existing Container App: $APP_NAME"
            az containerapp update \
              --name "$APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --image "$IMAGE" \
              --output none
            if [ -n "$DATABASE_URL" ]; then
              echo "Updating DATABASE_URL secret"
              az containerapp secret set \
                --name "$APP_NAME" \
                --resource-group "$AZURE_RESOURCE_GROUP" \
                --secrets "database-url=$DATABASE_URL" \
                --output none
              az containerapp update \
                --name "$APP_NAME" \
                --resource-group "$AZURE_RESOURCE_GROUP" \
                --set-env-vars "DATABASE_URL=secretref:database-url" \
                --output none
            fi
          else
            if [ -z "$DATABASE_URL" ]; then
              echo "::error::DATABASE_URL secret is required to create public-api Container App. Add it in repository Secrets."
              exit 1
            fi
            echo "Creating Container App: $APP_NAME"
            ACR_USER=$(az acr credential show --name "$ACR_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --query "username" -o tsv)
            ACR_PASS=$(az acr credential show --name "$ACR_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --query "passwords[0].value" -o tsv)
            az containerapp create \
              --name "$APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --environment "$ENV_NAME" \
              --image "$IMAGE" \
              --target-port 8000 \
              --ingress external \
              --registry-server "${ACR_NAME}.azurecr.io" \
              --registry-username "$ACR_USER" \
              --registry-password "$ACR_PASS" \
              --secrets "database-url=$DATABASE_URL" \
              --env-vars "DATABASE_URL=secretref:database-url" \
              --output none
          fi
          echo "Public API FQDN: $(az containerapp show --name $APP_NAME -g $AZURE_RESOURCE_GROUP --query 'properties.configuration.ingress.fqdn' -o tsv)"
      
      # Deploy registry-api to Container Apps (create on first run, update image on later runs)
      - name: Deploy registry-api to Container Apps
        env:
          ACR_NAME: ${{ secrets.ACR_NAME }}
          CONTAINER_APPS_ENV: ${{ vars.CONTAINER_APPS_ENV }}
        run: |
          set -e
          APP_NAME="secai-radar-registry-api"
          IMAGE="${ACR_NAME}.azurecr.io/secai-radar-registry-api:latest"
          ENV_NAME="${CONTAINER_APPS_ENV:-secai-radar-dev-env}"

          if az containerapp show --name "$APP_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --output none 2>/dev/null; then
            echo "Updating existing Container App: $APP_NAME"
            az containerapp update \
              --name "$APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --image "$IMAGE" \
              --output none
          else
            echo "Creating Container App: $APP_NAME"
            ACR_USER=$(az acr credential show --name "$ACR_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --query "username" -o tsv)
            ACR_PASS=$(az acr credential show --name "$ACR_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --query "passwords[0].value" -o tsv)
            az containerapp create \
              --name "$APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --environment "$ENV_NAME" \
              --image "$IMAGE" \
              --target-port 8001 \
              --ingress external \
              --registry-server "${ACR_NAME}.azurecr.io" \
              --registry-username "$ACR_USER" \
              --registry-password "$ACR_PASS" \
              --output none
          fi
          echo "Registry API FQDN: $(az containerapp show --name $APP_NAME -g $AZURE_RESOURCE_GROUP --query 'properties.configuration.ingress.fqdn' -o tsv)"
