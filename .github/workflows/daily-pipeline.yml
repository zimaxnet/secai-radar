name: Daily Pipeline

on:
  schedule:
    - cron: '30 2 * * *'  # 02:30 UTC daily
  workflow_dispatch:

jobs:
  record-start:
    name: Record Pipeline Start
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install psycopg2-binary>=2.9.0
      - name: Record pipeline start
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          pip install psycopg2-binary>=2.9.0
          cd apps/public-api
          python scripts/record_pipeline_run.py --start --trigger "github-actions"

  scout:
    name: Scout - Discovery
    needs: record-start
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run Scout
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd apps/workers/scout
          pip install -e .
          python src/scout.py

  curator:
    name: Curator - Canonicalization
    needs: scout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run Curator
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd apps/workers/curator
          pip install -e .
          python src/curator.py

  evidence-miner:
    name: Evidence Miner
    needs: curator
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run Evidence Miner
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd apps/workers/evidence-miner
          pip install -e .
          python src/evidence_miner.py

  scorer:
    name: Scorer
    needs: evidence-miner
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install psycopg2-binary>=2.9.0
          pip install pydantic>=2.0.0
          cd packages/scoring
          pip install -e .
      - name: Run Scorer
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          WRITE_TO_STAGING: "1"
        run: |
          cd apps/workers/scorer
          python src/scorer.py

  drift-sentinel:
    name: Drift Sentinel
    needs: scorer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run Drift Sentinel
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd apps/workers/drift-sentinel
          pip install -e .
          python src/drift_sentinel.py

  sage-meridian:
    name: Sage Meridian
    needs: drift-sentinel
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run Sage Meridian
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd apps/workers/sage-meridian
          pip install -e .
          echo "Running daily_brief.py..."
          ls -la src/
          python src/daily_brief.py

  publisher:
    name: Publisher
    needs: sage-meridian
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run Publisher
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd apps/workers/publisher
          pip install -e .
          python src/publisher.py
      - name: Record pipeline success
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          pip install psycopg2-binary>=2.9.0
          cd apps/public-api
          # Get the latest run_id from the database
          RUN_ID=$(python -c "
          import os, psycopg2
          conn = psycopg2.connect(os.getenv('DATABASE_URL'))
          cur = conn.cursor()
          cur.execute(\"SELECT run_id FROM pipeline_runs WHERE status = 'Running' ORDER BY started_at DESC LIMIT 1\")
          row = cur.fetchone()
          print(row[0] if row else '')
          conn.close()
          " 2>/dev/null || echo '')
          if [ -n "$RUN_ID" ]; then
            python scripts/record_pipeline_run.py --finish "$RUN_ID"
          fi
        if: success()  record-failure:
    name: Record Pipeline Failure
    needs: [record-start, scout, curator, evidence-miner, scorer, drift-sentinel, sage-meridian, publisher]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Record pipeline failure
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          pip install psycopg2-binary>=2.9.0
          cd apps/public-api
          # Get the latest run_id from the database
          RUN_ID=$(python -c "
          import os, psycopg2
          conn = psycopg2.connect(os.getenv('DATABASE_URL'))
          cur = conn.cursor()
          cur.execute(\"SELECT run_id FROM pipeline_runs WHERE status = 'Running' ORDER BY started_at DESC LIMIT 1\")
          row = cur.fetchone()
          print(row[0] if row else '')
          conn.close()
          " 2>/dev/null || echo '')
          if [ -n "$RUN_ID" ]; then
            python scripts/record_pipeline_run.py --finish "$RUN_ID" --failed
          fi
