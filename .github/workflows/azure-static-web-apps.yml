name: Build and Deploy SecAI Radar (SWA)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Build the web app
      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install & Build Web
        working-directory: web
        env:
          # Set API URL from secret or use default Function App URL
          VITE_API_BASE: ${{ secrets.VITE_API_BASE || 'https://secai-radar-api.azurewebsites.net/api' }}
        run: |
          npm ci
          npm run build

      # Deploy Web only (API is deployed separately as Function App)
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "upload"
          app_location: "web"
          output_location: "dist"
          # Removed api_location - API is now a separate Function App

      # Notify on failure with actionable details
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRun = context.payload.workflow_run || {
              html_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              conclusion: 'failure'
            };
            
            const commit = context.payload.head_commit || context.payload.commits?.[0] || {};
            const commitMessage = commit.message || 'No commit message';
            const commitAuthor = commit.author?.name || commit.author?.username || 'Unknown';
            const commitUrl = commit.url || `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${context.sha}`;
            
            // Get workflow run details
            const runDetails = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            // Get failed jobs
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            const failedSteps = failedJobs.flatMap(job => 
              job.steps?.filter(step => step.conclusion === 'failure').map(step => ({
                job: job.name,
                step: step.name,
                conclusion: step.conclusion
              })) || []
            );
            
            // Create actionable notification
            const issueBody = `## âŒ Workflow Failed: ${context.workflow}

### ğŸ” Workflow Details
- **Workflow**: ${context.workflow}
- **Branch**: ${context.ref.replace('refs/heads/', '')}
- **Commit**: [${commitMessage.split('\n')[0]}](${commitUrl})
- **Author**: ${commitAuthor}
- **Run**: [View Failed Run](${workflowRun.html_url})
- **Triggered by**: ${context.eventName} (${context.actor})

### âŒ Failed Jobs/Steps
${failedSteps.length > 0 ? failedSteps.map(step => `- **${step.job}** â†’ ${step.step}`).join('\n') : '- Unable to determine failed steps'}

### ğŸ”§ Next Steps
1. Review the [failed workflow run](${workflowRun.html_url}) for detailed error logs
2. Check the failed step(s) above for specific error messages
3. Fix the issue and push again

### ğŸ“‹ Common Issues
- **Build failures**: Check Node.js version, dependencies, or build errors
- **Deployment failures**: Verify Azure credentials and Static Web App settings
- **Configuration errors**: Check secrets and environment variables

---
*This issue was automatically created by GitHub Actions to track the failed workflow run.*`;

            // Create an issue to track the failure
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âŒ Workflow Failed: ${context.workflow} - ${context.ref.replace('refs/heads/', '')}`,
                body: issueBody,
                labels: ['workflow-failure', 'needs-attention']
              });
              console.log('âœ… Created issue for failed workflow');
            } catch (error) {
              console.log('âš ï¸ Could not create issue (may already exist or permissions issue):', error.message);
            }
